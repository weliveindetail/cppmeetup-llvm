<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>LLVM-based JIT Compilers</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/white.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

    <style>
      .reveal .slides section img.logo-tr { 
        border: 0px;
        margin: 0px;
        margin-top: -20px;
        opacity: 1.0;
        float: right; }

      .reveal .slides section.section-tl {
        text-align: left;
        vertical-align: top; }

      .reveal .slides section img.abspos {
        position: absolute;
        width: 200px;
        height: auto;
        margin: 0px;
        border: 0px; }

      .reveal .slides section img.replace {
        width: 0px;
        height: 0px;
        margin: 0px;
        border: 0px;
        transition: none; }

      .reveal .slides section img.replace.fragment.current-visible {
        opacity: 0;
        visibility: hidden;
        display: none; }

      .reveal .slides section img.replace.fragment.current-visible.current-fragment {
        opacity: 1;
        width: 100%;
        height: auto;
        visibility: visible;
        display: inline; }
    </style>

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

        <!-- ------------------------------------------------------------------------------------------------------------------ -->

				<section>
          <img data-src="img/llvm-logo.svg" width="300" height="300" alt="xxx" style="border: 0px; margin: 2px;">
					<h2>LLVM-based JIT Compilers</h2>
					<small style="width: 72%; padding: 10px 0px;">
            <table style="width: 100%;">
              <tr><td style="text-align: right;">
                Stefan Gränitz @ C++ Meetup, Berlin<br>
                Tuesday, March 15th 2016<br>
                <br>
                <br>
              </td></tr>
              <tr><td>
                <a href="mailto:stefan.graenitz@gmail.com">
                  <img data-src="img/icons/grey-mail.png" alt="xxx" style="border: 0px; width: 24px; height: 24px; margin: 2px;">
                  stefan.graenitz@gmail.com
                </a>
                <br>
                <a href="https://twitter.com/weliveindetail">
                  <img data-src="img/icons/grey-github.png" alt="xxx" style="border: 0px; width: 24px; height: 24px; margin: 2px;">
                  github.com/weliveindetail
                </a>
                <br>
                <a href="https://twitter.com/weliveindetail">
                  <img data-src="img/icons/grey-twitter.png" alt="xxx" style="border: 0px; width: 24px; height: 24px; margin: 2px;">
                  @weliveindetail
                </a>
              </td></tr>
            </table>
					</small>
				</section>

        <!-- ------------------------------------------------------------------------------------------------------------------ -->

        <section>
          <section>
            <h3 style="text-align: left;">What is a...</h3>
            <h1 style="text-align: center;">JIT Compiler?</h1>
          </section>
          <section style="text-align: left;">
            <h3>What is a JIT Compiler?</h3>
            <br>
            <b>Compiler</b><br>
            <ul>
              <li>&rarr; it does code transformations</li>
              <li>&rarr; typically from high-level source code to<br> low-level machine code</li>
            </ul>
            <br>
            <b>Just-In-Time</b><br>
            <ul>
              <li>&rarr; as close as possible to its actual execution</li>
            </ul>
          </section>
          <section style="text-align: left;">
            <h3>What people mean with JIT Compiler?</h3>
            <br>
            <blockquote cite="http://eli.thegreenplace.net/2013/11/05/how-to-jit-an-introduction">
              Whenever a program, while running, creates and runs some new executable code 
              which was not part of the program when it was stored on disk, it’s a JIT.
              <cite>Eli Bendersky</cite>
            </blockquote>
            <br>
            &rarr; widely used as a synonym for <b style="color: #c33;">Runtime Compiler</b>
            <br>
            &rarr; AOT means <b style="color: #c33;">Static Compiler</b>
          </section>
          <section style="text-align: left;">
            <h3>Difference Static vs. Runtime Compiler?</h3>
            <br>
            todo
          </section>
        </section>

        <section>
          <section>
            <h3 style="text-align: left;">What is...</h3>
            <h1 style="text-align: center;">LLVM?</h1>
          </section>
          <section style="text-align: left;">
            <h3>What is LLVM?</h3>
            <ul>
              <li>&rarr; compiler infrastructure</li>
              <li>&rarr; set of reusable libraries written in C++</li>
              <li>&rarr; started in 2003 by <a target="_blank" href="https://en.wikipedia.org/wiki/Chris_Lattner">Chris Lattner</a> (University of Illinois) as <i>Low Level Virtual Machine</i></li>
              <li>&rarr; today developed by the <a target="_blank" href="http://llvm.org/">LLVM Developer Group</a></li>
            </ul>
          </section>
          <section style="text-align: left;">
            <h3>Why is that interesting for C++ devs?</h3>
            <ul>
              <li>&rarr; huge code base:<br>open-source, modern C++</li>
              <li>&rarr; sophisticated requirements:<br>modularity, portability, efficiency</li>
              <li>&rarr; components that you might like to use</li>
              <li>&rarr; great development tools</li>
            </ul>
            <br>
            &hellip; and a good craftsman should know his tools!
          </section>
        </section>

        <!-- ------------------------------------------------------------------------------------------------------------------ -->

        <section>
          <section>
            <h1 style="text-align: center;">Projects</h1>
          </section>
          <section class="section-tl">
            <img data-src="img/projects/llvm-logo.svg" width="400" height="400" alt="xxx" class="logo-tr">
            <br><br><br><br><br>
            <h3 style="margin: 0px;">Clang &mdash; a compiler</h3>
            <a target="_blank" href="http://clang.llvm.org/">http://clang.llvm.org/</a>
            <ul>
              <li>&rarr; LLVM reference project</li>
              <li>&rarr; self-hosting since February, 2nd 2010</li>
              <li>&rarr; actively developed by Apple, Google, Microsoft, ARM, Sony, Intel, AMD, etc. &amp; the community</li>
              <li>&rarr; a great playground, also for the C++ standards committee</li>
            </ul>
          </section>
          <section class="section-tl">
            <img data-src="img/projects/root-banner.png" width="529" height="128" alt="xxx" class="logo-tr" style="margin-right: -56px;">
            <br><br><br>
            <h3 style="margin: 0px;">Cling &mdash; an interpreter</h3>
            <a target="_blank" href="https://root.cern.ch/cling-brief">https://root.cern.ch/cling-brief</a>
            <ul>
              <li>&rarr; replaces old CINT command line interpreter</li>
              <li>&rarr; rapid development tool for high energy physicists</li>
              <li>&rarr; let's see it in action!</li>
            </ul>
            <br>
          </section>
          <section class="section-tl">
            <img data-src="img/projects/google-logo.png" width="200" height="200" alt="xxx" class="logo-tr">
            <br><br><br><br>
            <h3 style="margin: 0px;">AddressSanitizer &mdash; a development tool</h3>
            <a target="_blank"
               href="https://github.com/google/sanitizers/wiki/AddressSanitizer">
                     https://github.com/google/sanitizers/wiki/AddressSanitizer</a>
            <ul>
              <li>&rarr; clang compiler flag <code>-fsanitize=address</code></li>
              <li>&rarr; detects dangling pointer dereference, stack buffer overflow, 
                         non-deterministic initialization, etc.</li>
              <li>&rarr; essentially implemented as LLVM ("optimization") pass</li>
              <li>&rarr; very low overhead: typically ~2x</li>
            </ul>
          </section>
          <section class="section-tl">
            <img data-src="img/projects/mapd_banner.png" width="200" height="auto" alt="xxx" class="logo-tr">
            <br><br><br><br>
            <h3 style="margin: 0px;">MapD &mdash; a visualization tool for big data</h3>
            <a target="_blank" 
              href="https://devblogs.nvidia.com/parallelforall/mapd-massive-throughput-database-queries-llvm-gpus/">
                    https://devblogs.nvidia.com/parallelforall/mapd-massive-throughput-database-queries-llvm-gpus/</a>
            <ul>
              <li>&rarr; JIT compiles database queries for runtime efficiency</li>
              <li>&rarr; code generation time under 30ms</li>
              <li>&rarr; LLVM IR to target specific CPU and/or GPU</li>
              <li>&rarr; uses system runtime information as compile-time input for queries</li>
            </ul>
          </section>
          <section class="section-tl">
            <img data-src="img/projects/emscripten_logo_full.png" width="408" height="111" alt="xxx" class="logo-tr">
            <br><br><br>
            <h3 style="margin: 0px;">Emscripten &mdash; a source-to-source compiler</h3>
            <a target="_blank"
               href="https://github.com/kripken/emscripten">
                     https://github.com/kripken/emscripten</a>
            <ul>
              <li>&rarr; compiles C/C++ to asm.js</li>
              <li>&rarr; examples: Unreal Engine 3, SQLite, Lua VM</li>
              <li>&rarr; claims to achieve "near-native" speed, but depends largely on use-case and client setup</li>
              <li>&rarr; <b>note:</b> code size grows rapidly, which counteracts efficiency (i.e. in transfer, parsing and locality of reference)</li>
            </ul>
          </section>
          <section class="section-tl">
            <img data-src="img/projects/wasm-logo.png" width="auto" height="180" alt="xxx" class="logo-tr">
            <br>
            <h3 style="margin: 0px;">Binaryen &mdash;<br> the WebAssembly toolchain</h3>
            <a target="_blank" 
              href="https://github.com/WebAssembly/binaryen">
                    https://github.com/WebAssembly/binaryen</a>
            <ul>
              <li>&rarr; <b>wasm</b>: portable, size- and load-time-efficient format suitable for compilation to the web</li>
              <li>&rarr; <b>binaryen</b>: parse &amp; compile to &amp; from wasm, interprete and polyfill (fallback to asm.js)</li>
              <li>&rarr; implemented as virtual Instruction Set Architecture directly in the upstream LLVM repo</li>
              <li>&rarr; initial support in clang <a target="_blank" href="http://reviews.llvm.org/rL246814">already merged back</a></li>
              <li>&rarr; plans are to ship MVP before end of 2016!</li>
            </ul>
          </section>
          <section class="section-tl">
            <img data-src="img/projects/juce-logo.svg" width="200" height="auto" alt="xxx" class="logo-tr">
            <br><br><br><br><br>
            <h3 style="margin: 0px;">Projucer &mdash; a live coding environment</h3>
            <a target="_blank" href="https://youtu.be/imkVkRg-geI?t=124">
                                     https://youtu.be/imkVkRg-geI?t=123</a>
            <ul>
              <li>&rarr; compiles JUCE C++ components on-the-fly and links them into a running executable</li>
              <li>&rarr; rapid development of C++ based UI</li>
            </ul>
          </section>
          <section class="section-tl">
            <img data-src="img/projects/Question_mark.svg" width="auto" height="200" alt="xxx" class="logo-tr">
            <br><br><br>
            <h3 style="margin: 0px;">StatefulJIT &mdash; a research project</h3>
            <a target="_blank" href="https://github.com/weliveindetail/StatefulJit">
                                     https://github.com/weliveindetail/StatefulJit</a>
            <ul>
              <li>&rarr; experimental implementation of a minimalistic language</li>
              <li>&rarr; playground to evaluate compiler-based techniques for <a href="https://en.wikipedia.org/wiki/Dynamic_software_updating">dynamic software updating</a></li>
              <li>&rarr; current focus is runtime state transfer for complex data types</li>
            </ul>
          </section>
          <section class="section-tl">
            <h3>Others..</h3>
            <ul>
              <li>
                <a href="https://github.com/ldc-developers/ldc">LDC</a>: LLVM D Compiler (alpha-state)
              </li>
              <li>
                <a href="https://www.rust-lang.org/">Rust</a>: systems programming language
              </li>
              <li>
                <a href="https://developer.apple.com/swift/">Swift</a>: Apple's attempt to replace Objective-C
              </li>
              <li>
                <a href="http://llvm.org/pubs/2010-09-HASKELLSYM-LLVM-GHC.pdf">GHC</a>: Glasgow Haskell Compiler<br>
              </li>
              <li>
                <a href="https://bitbucket.org/purelang/pure-lang/wiki/Faust2">FAUST</a>: Functional Audio Stream
              </li>
              <li>
                <a href="https://github.com/rubinius/rubinius">Rubinius</a>: high-performance env. for running Ruby code
              </li>
              <li>
                <a href="https://github.com/dotnet/llilc">LLILC</a>: aims to compile .NET's CoreCLR to LLVM IR<br>
              </li>
              <li>
                <a href="http://vuo.org/node/31">Vuo</a>: Visual programming environment
              </li>
              <li>
                and so on...
              </li>
            </ul>
          </section>
        </section>

        <!-- ------------------------------------------------------------------------------------------------------------------ -->

        <section>
          <section>
            <br><br><br>
            <h3 style="text-align: left;">Slight detour to...</h3>
            <h1 style="text-align: center;">Compiler<br>Construction</h1>

            <img class="fragment fade-in abspos" style="left: 3%; top: 60%;" frament-index="0" data-src="img/cc/books/0.jpg" alt="xxx">
            <img class="fragment fade-in abspos" style="left: 55%; top: 55%;" frament-index="1" data-src="img/cc/books/1.jpg" alt="xxx">
            <img class="fragment fade-in abspos" style="left: 30%; top: 45%;" frament-index="2" data-src="img/cc/books/2.jpg" alt="xxx">
            <img class="fragment fade-in abspos" style="left: 80%; top: 20%;" frament-index="3" data-src="img/cc/books/3.jpg" alt="xxx">

            <aside class="notes">
              Well-understood in computer science
            </aside>
          </section>
          <section>
            <h3>What is the goal?</h3>
            <div class="fragment" data-fragment-index="1">
              <img data-src="img/cc/helloworld_cpp.png" width="300" height="auto" alt="xxx" style="border: 0px; vertical-align: middle;">
              <span style="font-size: 200px; vertical-align: middle; margin: 50px;">&rarr;</span>
              <img data-src="img/cc/helloworld_asm.jpg" width="200" height="auto" alt="xxx" style="border: 0px; vertical-align: middle;">
            </div>
          </section>
          <section style="vertical-align: top;">
            <h3>Ok step by step..</h3>
            <img class="fragment current-visible replace" frament-index="0" data-src="img/cc/src-to-exec-0.svg" alt="xxx">
            <img class="fragment current-visible replace" frament-index="1" data-src="img/cc/src-to-exec-1.svg" alt="xxx">
            <img class="fragment current-visible replace" frament-index="2" data-src="img/cc/src-to-exec-2.svg" alt="xxx">
            <img class="fragment current-visible replace" frament-index="3" data-src="img/cc/src-to-exec-3.svg" alt="xxx">
            <br><br><br><br>
            <!--<p class="fragment" data-fragment-index="4" style="font-size: 200px; text-align: left; margin-top: -150px; padding-left: 165px; color: #d22;">&uarr;</p>-->
          </section>
          <section>
            <h3>The compilation step in detail</h3>
            <img class="fragment current-visible fade-in replace" frament-index="0" data-src="img/cc/src-to-asm-0.svg" alt="xxx">
            <img class="fragment current-visible fade-in replace" frament-index="1" data-src="img/cc/src-to-asm-1.svg" alt="xxx">
            <img class="fragment current-visible fade-in replace" frament-index="2" data-src="img/cc/src-to-asm-2.svg" alt="xxx">
            <img class="fragment current-visible fade-in replace" frament-index="3" data-src="img/cc/src-to-asm-3.svg" alt="xxx">
            <br><br><br><br>
            <aside class="notes">
              AST: redundancy
              IR: Static Single Assignment / 3-Adress-Code
            </aside>
          </section>
        </section>


        <!-- ------------------------------------------------------------------------------------------------------------------ -->

        <section>
          <section>
            <h1 style="text-align: center;">LLVM Architecture</h1>
          </section>
          <section>
            3-phase design
            compiler basics
          </section>
          <section>
            IR and its role
            * well-specified
            * not platform specific (but also not necessarily identical on different platforms)
            * source language neutral

            * by itself neither fully portable nor fully stable
            * designed for compiler optimizations

            * compare to GCC on debug info example

            &rarr; IR language reference
          </section>
          <section>
            Optimizer:
            * IR is the only interface
            * single passes
            * PassManager resolves dependencies and optimizes the execution

            &rarr; writing a pass
          </section>
          <section>
            GCC not reusable as library, because it's designed as a monolithic application (no strict separation of frontend/optimizer/backend)
          </section>
          <section>
            JVM and .Net are opaque virtual machines (optimizer - backend not modular)
          </section>
          <section>
            However, from the scientific point of view there is nothing new in LLVM. Three-Phase-Design is well understood and implemented in other experimental compilers like SUIF, but more specific research and not production ready.

            LLVM came at the right time and did the right thing!
            * 
            * native programming is back! interest and investing in C++ and COMPILERS grows again since 2010
            * many new architectures for mobile processors and GPUs
            * static compilers and runtime compilers in one framework
            * high demand for build tools, which benefit a lot from LLVM modularity
          </section>
        </section>

        <!-- ------------------------------------------------------------------------------------------------------------------ -->

        <section>
          <section>
            <h1 style="text-align: center;">Conceptual Advantages</h1>
          </section>
          <section>
            reuse the libraries in your project: demo HowToJIT example in sublime
            compiler basic: compile-time vs. runtime! interesting and challenging!
          </section>
          <section>
            Link-Time Optimization
            * no expensive serialization (naturally not required)
            * across different source languages
          </section>
          <section>
            Install-Time Optimization
            * delay codegen to installation
            * match instruction choice, scheduling to the specific machine's hardware
          </section>
          <section>
            Unit Testing the Optimizer

            * traditional approaches: 
            ** run .c file through compiler to test that it doesn't crash (GCC)
            ** compile huge programs with nightly builds and run automated user-interactions (MSVC)

            * textual LLVM IR &amp; modular optimizer:
            ** e.g. test constant folding pass individually
            ** verify that it actually performed!
            ** not possible with the c file appraoch, as front-ends may optimize constant folding too
          </section>
        </section>

        <!-- ------------------------------------------------------------------------------------------------------------------ -->

        <section>
          <section>
            <h1 style="text-align: center;">Setup and tutorials</h1>
          </section>
          <section class="section-tl">
            setup llvm (build and install)
            mac and simple: brew install llvm
            others: http://llvm.org/docs/CMake.html
          </section>
          <section class="section-tl">
            guided C++ coding &rarr; easy
            learn how to write a parser to translate your representation to LLVM
            http://llvm.org/docs/tutorial/index.html
          </section>
          <section class="section-tl">
            explorative C++ coding &rarr; medium
            start from scratch with the HowToJIT example
            !! make github repo !!

            <code>git clone http://github.com/weliveindetail/HowToJitFromScratch</code>
          </section>
          <section class="section-tl">
            requires some compiler and IR knowhow &rarr; advanced
            learn how to write an optimization pass
            http://llvm.org/docs/tutorial/index.html

            * useful for custom optimizations
            * useful for binary instrumentation
          </section>
        </section>

        <!-- ------------------------------------------------------------------------------------------------------------------ -->

        <section>
          <section>
            <h1 style="text-align: center;">Experimenting with a JIT Compiler</h1>
          </section>
          <section class="section-tl">
            whatever &rarr; LLVM IR &rarr; executable code &rarr; function pointer
          </section>
        </section>

        <!-- ------------------------------------------------------------------------------------------------------------------ -->

        <section>
          <section>
            <h1 style="text-align: center;">Learning from LLVM</h1>
          </section>
          <section class="section-tl">
            <blockquote cite="http://www.aosabook.org/en/llvm.html">
              None of the subsystems in LLVM are really good until they have been rewritten at least once.
            </blockquote>
            <blockquote cite="http://www.aosabook.org/en/llvm.html">
              After all, the goal isn't to be perfect, it is to keep getting better over time.
              <cite>Chris Lattner</cite>
            </blockquote>
          </section>
          <section class="section-tl">
            LLVM Coding Standards  "you only pay for what you use" approach
            http://llvm.org/docs/CodingStandards.html

            * good structure great reasoning
            * few style conventions like naming and bracing
          </section>
          <section>
            Hand-rolled RTTI
            http://llvm.org/docs/HowToSetUpLLVMStyleRTTI.html

            * more efficient and flexible
            * fully explicit &rarr; use only where necessary
            * no implicit limitations
          </section>
          <section class="section-tl">
            Bugpoint
            http://llvm.org/docs/Bugpoint.html

            * automatically reduces the amount of code necessary to reproduce a bug
            * trade off programmer time for computer time in the compiler-debugging process
          </section>
        </section>

        <!-- ------------------------------------------------------------------------------------------------------------------ -->

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
